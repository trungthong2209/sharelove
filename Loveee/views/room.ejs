<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="/socket.io/socket.io.js"></script>
 
    <title> <%= room %> </title>
</head>
<body>
  <div class="chat-container">
    <header class="chat-header">
      <h1><i class="fas fa-smile"></i> Share Love</h1>
               
    </header>
   
    <main class="chat-main">
      <div class="chat-sidebar">
        <h3><i class="fas fa-comments"></i> Room Name:</h3>
        <h2 id="room-name"></h2>
        <h3><i class="fas fa-users"></i> Users Online</h3>
        <ul id="users">
          </ul>
      </div>
      <div class="chat-messages"></div>
    </main>
    
    <div class="chat-form-container" >
      <form id="chat-form" name = chat-form action="/room/<%=room%>" method="POST">
        <input
          id="msg"
          name = "msg"
          type="text"
          placeholder="Nhập văn bản"
          required
          autocomplete="off"
        />
        <button type="button" onClick= "getMess()" >OK</button>
        
      
    </form>
    </div>
  </div>
</body>

  <script>
const chatForm= document.getElementById('chat-form');
const chatMessage= document.querySelector(".chat-messages");
const roomName = document.getElementById("room-name");
const userList = document.getElementById("users");
const room  = window.location.pathname.split('/')[2];
console.log(room);
if(room!==null && room!=="" && room!==undefined){
  var socket = io("http://localhost:3000");
if(socket!==undefined){
  console.log("Connected to server");
  //function
  socket.emit("joinRoom", room);
  socket.on("roomUsers", ({users,room}) =>{
    outputRoomName(room);
    outputUsers(users);
});
socket.on("message", message =>{
console.log(message);
outputMessage(message);
chatMessage.scrollTop=chatMessage.scrollHeight;
});
}
}

function getMess(){
  const msg = document.getElementById('msg').value;
  socket.emit("chatMessage", msg);
  var frm = document.getElementsByName('chat-form')[0];
  frm.submit();
  frm.reset();
}

function outputMessage(message){
    const div = document.createElement("div");
    div.classList.add("message");
    div.innerHTML = `<p class="meta">${message.username} <span>${message.time}</span></p>
    <p class="text">
       ${message.text}
    </p>`;
    document.querySelector('.chat-messages').appendChild(div);
}
function outputRoomName(room){
    roomName.innerText = room;
}
function outputUsers(users){
    userList.innerHTML =`
    ${users.map(user => `<li>${user.username}</li>`).join('')}`; 
}
</script>
</html>